var im_path="http://www.51offer.com/im";var im_radd_path="http://www.51offer.com";var mall_path="http://mall.51offer.com";var userlist=new Array();var cuser=0;var user_name="";var myid="m_"+$.cookie("loginId");var myname=$.cookie("companyName");var currentpage=0;var pagesize=200;var noReadFlag=0;var totalNoRead=0;$(function(){$("#sectionUser").perfectScrollbar();$("#sectionUser").scrollLeft(300);$("#sectionUser").perfectScrollbar("update");$("#ChatText").perfectScrollbar();$("#ChatText").scrollLeft(300);$("#ChatText").perfectScrollbar("update");$("#recordText").perfectScrollbar();$("#recordText").scrollLeft(300);$("#recordText").perfectScrollbar("update");$("#message").keydown(function(A){var B=A.which;if(B==13){sendMessage()}});$(".btnRecord").click(function(){var A=$(".recordWrap");var B=$(".orderWrap");if(A.is(":visible")){A.hide();B.show()}else{A.show();B.hide();loadHistoryMessage()}});clickShow(".btnRecordClose",".recordWrap",".orderWrap");loginIM();loadMyBuyers(0,null);window.setInterval(function(){loadMyBuyers(1,{options:userlist})},10000);window.setInterval(function(){if(0!=noReadFlag){countNoRead(noReadFlag)}},12000);window.setInterval(function(){if(0!=cuser){loadCurrentUserUnreadMessage(cuser)}},5000)});function clickShow(C,A,B){$(C).click(function(){$(A).hide();$(B).show()})}function loginIM(){var A=im_path+"/message!setObjectOnline.action?callBack=?";var B={object_name:myid};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:B,success:function(C){},error:function(C){}})}function loadMyBuyers(C,B){var E=0;var D=0;var A=im_path+"/message!getChatObjectInfo.action?callBack=?";var F={mer_id:myid,load_status:C};$.post(A,F,function(K){if(K!=null){var H=K.if_update;var I=K.object_list;if(H=="1"){$(".userList").html("");$("#onlineTotal").html("");var M="";userlist.splice(0,userlist.length);if(null!=I){noReadFlag=1;E=I.length;for(var J=0;J<I.length;J++){var G=I[J].user_id;var L=I[J].username;var N=I[J].if_online;var O={user_id:G,if_online:N};M+='<a href="javascript:void(0)" onclick="changeUser('+G+')"';if(0==C&&0==J){M+=' class="active"';user_name=L;$("#imUserName").html(user_name);if(0==cuser){cuser=G;loadCurrentMessage(cuser)}loadUserRelation()}M+=' id="'+G+'" title="'+L+'">'+L+"</a>";if("1"==N){D++}userlist.push(O)}}else{if(null==I){$(".userList").html('<p style=" padding:5px; text-align:center; font-weight:bold;">尚未与任何用户建立沟通联系</p>')}}countNoRead(C);$(".userList").html(M);$("#onlineTotal").html("（"+D+"/"+E+"）")}else{if(H=="2"){}else{}}}},"jsonp")}function loadCurrentUserUnreadMessage(){if(0==cuser||null==cuser||null==myid){return false}var A=im_path+"/message!getUserMessage.action?callBack=?";var B={receiver_key:myid,send_key:"q_"+cuser};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:B,success:function(F){if(null!=F){var E=$(".chatTextInfo").html();$(".chatTextInfo").html("");$("#nm_"+cuser).remove();for(var D=0;D<F.length;D++){var C=F[D].send_key;var H=F[D].send_time;var G=F[D].message_content;if(myid==C){E+='<dl class="green"><dt>'+myname+"&nbsp;&nbsp;"+H+"</dt><dd>"+decodeURI(decodeURI(G))+"</dd></dl>"}else{E+='<dl class="blue"><dt>'+user_name+"&nbsp;&nbsp;"+H+"</dt><dd>"+decodeURI(decodeURI(G))+"</dd></dl>"}}$("#chatTextInfo").scrollTop(0);$("#chatTextInfo").perfectScrollbar("update");$(".chatTextInfo").html(E);scrollheight("ChatText",$("#ChatText").innerHeight())}},error:function(C){}})}function loadCurrentMessage(B){var A=im_path+"/message!getChatMessage.action?callBack=?";var C={userid:"q_"+B,consultantid:myid};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:C,success:function(G){if(null!=G){$(".chatTextInfo").html("");$("#nm_"+B).remove();var F="";for(var E=0;E<G.length;E++){var D=G[E].send_key;var I=G[E].send_time;var H=G[E].message_content;if(myid==D){F+='<dl class="green"><dt>'+myname+"&nbsp;&nbsp;"+I+"</dt><dd>"+H+"</dd></dl>"}else{F+='<dl class="blue"><dt>'+user_name+"&nbsp;&nbsp;"+I+"</dt><dd>"+H+"</dd></dl>"}}$("#chatTextInfo").scrollTop(0);$("#chatTextInfo").perfectScrollbar("update");$(".chatTextInfo").html(F);scrollheight("ChatText",$("#ChatText").innerHeight())}},error:function(D){}})}function sendMessage(){var B=$("#message").val();var A=im_path+"/message!addMessageLog.action?callBack=?";if(null==B||0==$.trim(B).length){alert("请输入聊天内容！");return false}B=$.trim(B);if(getLength(B)>1000){alert("消息内容不能超过1000");return false}$("#message").attr("disabled","disabled");$(".submit").attr("disabled","disabled").css({"background":"gray"});var C={send_key:myid,receiver_key:"q_"+cuser,message_content:encodeURI(B)};jQuery.ajax({url:A,processData:true,dataType:"json",async:false,type:"post",data:C,success:function(D){if(null!=D){$("#message").val("");$("#message").removeAttr("disabled");$(".submit").removeAttr("disabled").css({"background":"#FF9C00"});loadCurrentMessage(cuser)}},error:function(D){}})}function changeUser(A){if(typeof(A)=="undefined"||0==cuser){return}cuser=A;$(".userList").children("a").each(function(){var C=$(this).attr("id");$(this).removeClass("active");if(C==cuser){$(this).addClass("active");user_name=$(this).attr("title");$("#imUserName").html(user_name);var B=$("#nm_"+C);if(B instanceof Object){var D=B.attr("val");B.remove();totalNoRead-=D;if(totalNoRead>0){totalNoRead=totalNoRead>99?99:totalNoRead;$("#imHref").html("客户咨询<span>"+totalNoRead+"</span>")}else{$("#imHref").children("span").remove()}}loadUserRelation()}});currentpage=0;$("#recordTextInfo").html("");scrollheight("ChatText",$("#ChatText").innerHeight());loadCurrentMessage(A);$(".recordWrap").hide();$(".orderWrap").show()}function countNoRead(B){var A=im_path+"/message!getUnreadMessage.action?callBack=?";var C={receiver_key:myid,flag:B};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:C,success:function(F){if(null!=F&&F.length>0){totalNoRead=0;for(var E=0;E<F.length;E++){var H=F[E].count;var D=F[E].send_key;var G=$("#"+D).html();$("#nm_"+D).remove();if(H>99){G+='<i id="nm_'+D+'" val="'+H+'">99条</i>';$("#"+D).html(G)}else{if(H>0){G+='<i id="nm_'+D+'" val="'+H+'">'+H+"条</i>";$("#"+D).html(G)}}totalNoRead+=H}if(totalNoRead>0){totalNoRead=totalNoRead>99?99:totalNoRead;$("#imHref").html("客户咨询<span>"+totalNoRead+"</span>");return true}}$("#imHref").children("span").remove()},error:function(D){}})}function loadHistoryMessage(){if($.trim($(".recordTextInfo").html()).length>0){return false}var A=im_path+"/message!getMessagesRecord.action?callBack=?";var B={chatA:myid,chatB:"q_"+cuser,pageno:currentpage,pagesize:pagesize};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:B,success:function(G){$(".recordTextInfo").html("");if(null!=G){var E=G.message_list;var D=G.message_count;var H="";for(var F=0;F<E.length;F++){var C=E[F].send_key;var I=E[F].send_time;var J=E[F].message_content;if(myid==C){H='<dl class="green"><dt>'+myname+"&nbsp;&nbsp;"+I+"</dt><dd>"+J+"</dd></dl>"+H}else{H='<dl class="blue"><dt>'+user_name+"&nbsp;&nbsp;"+I+"</dt><dd>"+J+"</dd></dl>"+H}}if(D>(currentpage+1)*pagesize){H='<p class="getMore" id="hm_'+cuser+'" onclick="loadMoreHistoryMsg('+(currentpage+1)+')"><i class="btn_getMore"></i>点击加载更多</p>'+H}$(".recordTextInfo").html(H);scrollheight("recordTextInfo",$("#recordTextInfo").height())}},error:function(C){}})}function loadMoreHistoryMsg(B){var A=im_path+"/message!getMessagesRecord.action?callBack=?";currentpage=B;var C={chatA:myid,chatB:"q_"+cuser,pageno:currentpage,pagesize:pagesize};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:C,success:function(H){if(null!=H){var F=H.message_list;var E=H.message_count;var I="";$("#hm_"+cuser).remove();for(var G=0;G<F.length;G++){var D=F[G].send_key;var J=F[G].send_time;var K=F[G].message_content;if(myid==D){I='<dl class="green"><dt>'+myname+"&nbsp;&nbsp;"+J+"</dt><dd>"+decodeURI(decodeURI(K))+"</dd></dl>"+I}else{I='<dl class="blue"><dt>'+user_name+"&nbsp;&nbsp;"+J+"</dt><dd>"+decodeURI(decodeURI(K))+"</dd></dl>"+I}}if(E>(currentpage+1)*pagesize){I='<p class="getMore" id="hm_'+cuser+'" onclick="loadMoreHistoryMsg('+(currentpage+1)+')"><i class="btn_getMore"></i>点击加载更多</p>'+I}$(".recordTextInfo").prepend(I);scrollheight("recordTextInfo",$("#recordTextInfo").height())}},error:function(D){}})}function scrollheight(C,A){var B=document.getElementById(C);if(B.scrollHeight<A){$(B).find(".ps-scrollbar-y").remove();B.scrollTop=0}else{B.scrollTop=B.scrollHeight}}function loadUserRelation(){$(".orderWrap").html("");var A=im_path+"/message!findChatRelationInfo.action?callBack=?";var B={sellerId:$.cookie("loginId"),userId:cuser};jQuery.ajax({url:A,processData:true,dataType:"json",type:"post",data:B,success:function(D){if(null!=D){var E=D.goods_id;var C=D.order_id;loadGoodsOrderInfo(cuser,E,C)}},error:function(C){}})}function loadGoodsOrderInfo(A,B,C){var D=mall_path+"/im/init/right.html";B=typeof(B)=="undefined"?"":B;C=typeof(C)=="undefined"?"":C;var E={sellerId:$.cookie("loginId"),userId:A,goodsId:B,orderCode:C};jQuery.ajax({url:D,processData:true,dataType:"jsonp",jsonp:"callback",type:"post",data:E,success:function(H){var G="";var L="";var I="";if(null!=H){var K=H.orderAndGoods;var J=H.historyOrderList;if(K!=null){G='<div class="order curOrder"><dl><dt>商品名称：</dt><dd><a target="_blank" href="'+mall_path+"/goods/info.html?goodsId="+K.goodsId+'" title="'+K.goodsName+'">'+K.goodsName+'</a></dd></dl><dl class="dl1"><dt>商品分类：</dt><dd>'+K.goodsTypeValue+'</dd></dl><dl class="dl1"><dt>商品价格：</dt><dd>'+K.goodsPrice+"元</dd></dl>";if(null!=K.orderCode&&""!=K.orderCode){G+='<dl class="last"><dt>当前订单：</dt><dd><a target="_blank" href="'+ctx+"/seller_order/detail.do?orderCode="+K.orderCode+'" title="订单号：'+K.orderCode+'">订单号：'+K.orderCode+"</a><span>"+K.orderStatusValue+"</span></dd></dl>"}G+="</div>"}if(J!=null&&J.length>0){L='<div class="order"><dl><dt>其他订单：</dt>';for(var F=0;F<J.length;F++){L+='<dd><a target="_blank" href="'+ctx+"/seller_order/detail.do?orderCode="+J[F].ORDER_CODE+'" title="订单号：'+J[F].ORDER_CODE+'">订单号：'+J[F].ORDER_CODE+"</a><span>"+J[F].ORDER_STATUS_VALUE+"</span></dd>"}L+="</dl></div>"}I=G+L}if(I.lenght==0){I='<p class="noInfo">商品信息暂无</p>'}$(".orderWrap").html(I)},error:function(F){}})}function getLength(B){var C=0;var D=B.split("");for(var A=0;A<D.length;A++){if(D[A].charCodeAt(0)<299){C++}else{C+=2}}return C}window.onload=loadPage;